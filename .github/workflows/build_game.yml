name: Build Game

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get Project Path
        id: find_yyp
        run: |
          $yyp = Get-ChildItem -Path ${{ github.workspace }} -Filter *.yyp | Select-Object -First 1
          "yyp-path=$yyp" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      - name: Setup Igor
        uses: bscotch/igor-setup@v3
        id: igor
        with:
          target-yyp: ${{ steps.find_yyp.outputs.yyp-path }}
          access-key: ${{ secrets.GAMEMAKER_KEY }}
          modules: windows
          cache: true
      - name: Build with Igor
        uses: bscotch/igor-build@v1
        id: build
        with:
          yyp-path: ${{ steps.find_yyp.outputs.yyp-path }}
          user-dir: "${{ steps.igor.outputs.user-dir }}"
          platform: windows
      - name: Extract Build
        run: |
          Expand-Archive -Path "${{ steps.build.outputs.out-dir }}\${{ steps.build.outputs.out-name }}" -DestinationPath extracted
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: build-windows
          path: extracted
          retention-days: 1

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get Project Path
        id: find_yyp
        run: |
          yyp=$(find "${{ github.workspace }}" -maxdepth 1 -type f -name "*.yyp" | head -n 1)
          echo "yyp-path=$yyp" >> $GITHUB_OUTPUT
      - name: Setup Igor
        uses: bscotch/igor-setup@v3
        id: igor
        with:
          target-yyp: ${{ steps.find_yyp.outputs.yyp-path }}
          access-key: ${{ secrets.GAMEMAKER_KEY }}
          modules: mac
          cache: true
      - name: Build with Igor
        uses: bscotch/igor-build@v1
        id: build
        with:
          yyp-path: ${{ steps.find_yyp.outputs.yyp-path }}
          user-dir: "${{ steps.igor.outputs.user-dir }}"
          platform: mac
      - name: Extract Build
        run: |
          unzip "${{ steps.build.outputs.out-dir }}/${{ steps.build.outputs.out-name }}" -d extracted
      - name: Install signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
      - name: Sign and enable Hardened Runtime
        run: |
          APP_PATH=$(find extracted -name "*.app" | head -1)

          # Create entitlements file
          cat > "$RUNNER_TEMP/entitlements.plist" <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>com.apple.security.cs.disable-library-validation</key>
            <true/>
          </dict>
          </plist>
          EOF

          codesign --force --deep --options runtime --entitlements "$RUNNER_TEMP/entitlements.plist" --sign "Developer ID Application" "$APP_PATH"
      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH=$(find extracted -name "*.app" | head -1)
          ZIP_PATH="$RUNNER_TEMP/app.zip"

          # Create zip for notarization
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

          # Submit for notarization
          xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait \
            --output-format json | tee "$RUNNER_TEMP/notarization_result.json"

          # Extract submission ID and fetch the log (shows details on failure)
          SUBMISSION_ID=$(python3 -c "import sys,json; print(json.load(open('$RUNNER_TEMP/notarization_result.json')).get('id',''))")
          if [ -n "$SUBMISSION_ID" ]; then
            echo "Fetching notarization log for submission $SUBMISSION_ID..."
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" || true
          fi

          # Check status and fail if not accepted
          STATUS=$(python3 -c "import sys,json; print(json.load(open('$RUNNER_TEMP/notarization_result.json')).get('status',''))")
          if [ "$STATUS" != "Accepted" ]; then
            echo "Notarization failed with status: $STATUS"
            exit 1
          fi

          # Staple the notarization ticket
          xcrun stapler staple "$APP_PATH"
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: build-macos
          path: extracted
          retention-days: 1

  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get Project Path
        id: find_yyp
        run: |
          yyp=$(find "${{ github.workspace }}" -maxdepth 1 -type f -name "*.yyp" | head -n 1)
          echo "yyp-path=$yyp" >> $GITHUB_OUTPUT
      - name: Setup cache
        id: cache-system-libraries
        uses: actions/cache@v4
        with:
          path: emsdk-cache
          key: emsdk-cache
      - uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.47
          actions-cache-folder: emsdk-cache
      - name: Setup Igor
        uses: bscotch/igor-setup@v3
        id: igor
        with:
          target-yyp: ${{ steps.find_yyp.outputs.yyp-path }}
          access-key: ${{ secrets.GAMEMAKER_KEY }}
          modules: operagx
          cache: true
      - name: Build with Igor
        uses: bscotch/igor-build@v1
        id: build
        with:
          yyp-path: ${{ steps.find_yyp.outputs.yyp-path }}
          user-dir: ${{ steps.igor.outputs.user-dir }}
          platform: operagx
      - name: Extract Build
        run: |
          unzip "${{ steps.build.outputs.out-dir }}/${{ steps.build.outputs.out-name }}" -d extracted
      - name: Patch Build
        run: |
          sed -i 's/runner\.js/SPACEHOLE.js/g' extracted/runner-sw.js
          cat > /tmp/insert.txt << 'EOF'
                      const g_pWadLoadCallback = function () {};
                      var bodyElement = document.getElementById("canvas");
                      bodyElement.addEventListener("click", function () {
                          canvasElement.focus();
                      });
          EOF
          sed -i '/const CHANGE_ASPECT_RATIO = true;/r /tmp/insert.txt' extracted/index.html
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: build-web
          path: extracted
          retention-days: 1

  deploy:
    needs: [build-windows, build-macos, build-web]
    runs-on: ubuntu-latest
    steps:
      - name: Download Builds
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: build

      - name: Setup butler
        uses: remarkablegames/setup-butler@v2

      - name: Upload to itch.io
        run: |
          butler push build/build-windows benjamin-halko/spacehole:windows
          butler push build/build-macos benjamin-halko/spacehole:macos
          butler push build/build-web benjamin-halko/spacehole:web
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
